services:
  traefik:
    ports:
      - "80:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik-dev.yml:/etc/traefik/traefik.yml:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`traefik.localhost`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

  backend:
    environment:
      FLASK_ENV: development
      FLASK_DEBUG: "1"
    volumes:
      - ./backend:/app
      - gallery-data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-dev.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/images`))"
      - "traefik.http.routers.backend-dev.entrypoints=web"
      - "traefik.http.routers.backend-dev.service=backend-dev"
      - "traefik.http.services.backend-dev.loadbalancer.server.port=8000"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev
    environment:
      NODE_ENV: development
    volumes:
      - ./frontend:/app
      - /app/node_modules
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-dev.rule=Host(`localhost`)"
      - "traefik.http.routers.frontend-dev.entrypoints=web"
      - "traefik.http.routers.frontend-dev.service=frontend-dev"
      - "traefik.http.services.frontend-dev.loadbalancer.server.port=5173"
